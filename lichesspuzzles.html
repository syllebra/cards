<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lichess Tactiques V15 - Tap Only</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .board-container {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            overflow: hidden;
            /* Pas de touch-action: none ici car on veut que le tap fonctionne nativement, 
               mais on bloque le zoom sur l'app via meta viewport */
        }

        /* Thème Bleu */
        .white-1e1d7 { background-color: #f0f9ff; color: #3b82f6; }
        .black-3c85d { background-color: #60a5fa; color: #f0f9ff; }

        /* Case sélectionnée (Vert) */
        .highlight-selected {
            box-shadow: inset 0 0 3px 3px #22c55e !important;
        }

        /* Dernier coup (Jaune) */
        .highlight-move {
            background-color: rgba(255, 255, 0, 0.5) !important;
        }
        .black-3c85d.highlight-move {
            background-color: #a3e635 !important; 
        }

        /* Indication Aide (Violet) */
        .highlight-hint {
            box-shadow: inset 0 0 0 4px #a855f7 !important;
            animation: pulse-purple 2s infinite;
        }

        /* --- INDICES VISUELS --- */
        .hint-legal-move::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 25%; height: 25%;
            background-color: rgba(0, 0, 0, 0.25);
            border-radius: 50%;
            pointer-events: none;
        }

        .hint-legal-capture {
            box-shadow: inset 0 0 0 4px rgba(239, 68, 68, 0.6) !important;
        }
        .hint-legal-capture::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(transparent 55%, rgba(239, 68, 68, 0.2) 100%);
            pointer-events: none;
        }

        @keyframes pulse-purple {
            0% { box-shadow: inset 0 0 0 4px #a855f7; }
            50% { box-shadow: inset 0 0 0 8px #d8b4fe; }
            100% { box-shadow: inset 0 0 0 4px #a855f7; }
        }

        /* --- MODALE DE PROMOTION --- */
        #promotion-modal {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
        }
        .promo-piece {
            transition: transform 0.1s;
            cursor: pointer;
        }
        .promo-piece:active {
            transform: scale(0.9);
        }

        /* Effet de flou pour les infos cachées */
        .blur-info {
            filter: blur(5px);
            opacity: 0.6;
            pointer-events: none;
            user-select: none;
        }
        .info-transition {
            transition: filter 0.5s ease, opacity 0.5s ease;
        }

        body {
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-white h-screen flex flex-col font-sans overflow-hidden">

    <!-- HEADER -->
    <div class="w-full bg-slate-800 shadow-md z-10 p-3 flex-none border-b border-slate-700">
        <div class="flex justify-between items-center max-w-md mx-auto relative">
            <div class="flex items-center space-x-2">
                <i class="fas fa-chess-knight text-blue-400 text-xl"></i>
                <h1 class="font-bold text-lg">Tactiques</h1>
            </div>

            <div id="demo-badge" class="hidden absolute left-1/2 transform -translate-x-1/2 bg-orange-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded-full border border-orange-400 animate-pulse">
                MODE DÉMO
            </div>
            
            <div class="flex items-center space-x-3">
                <button id="toggle-info-btn" class="text-slate-400 hover:text-white transition p-2" title="Afficher/Masquer les infos">
                    <i id="info-icon" class="fas fa-eye-slash"></i>
                </button>
                <div id="rating-container" class="bg-slate-700 px-3 py-1 rounded-full flex items-center space-x-2 border border-slate-600 info-transition blur-info">
                    <i class="fas fa-trophy text-yellow-400 text-sm"></i>
                    <span id="puzzle-rating" class="font-mono font-bold text-yellow-100">---</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="flex-grow flex flex-col justify-center items-center w-full max-w-md mx-auto px-2 relative">
        
        <!-- Adversaire -->
        <div class="w-full flex justify-between items-end mb-2 px-1 relative z-0">
            <div class="flex items-center space-x-2 opacity-80">
                <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center border border-red-400/50">
                    <i class="fas fa-robot text-red-400"></i>
                </div>
                <div class="flex flex-col leading-tight">
                    <span id="top-player-name" class="text-sm font-semibold">Adversaire</span>
                    <span id="top-player-rating" class="text-xs text-gray-400 font-mono"></span>
                </div>
            </div>
            <div id="top-indicator" class="hidden px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded animate-pulse">
                À son tour
            </div>
        </div>

        <!-- Zone de message flottante -->
        <div id="status-message" class="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-2 rounded-full font-bold shadow-2xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none whitespace-nowrap border border-white/10 bg-slate-800/95 backdrop-blur text-sm">
            Message
        </div>

        <!-- ECHIQUIER + Overlay Promotion -->
        <div class="relative w-full max-w-[400px]">
            <div id="myBoard" class="w-full board-container aspect-square"></div>
            
            <!-- MODALE PROMOTION -->
            <div id="promotion-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center rounded-lg">
                <div class="bg-slate-800 p-4 rounded-xl shadow-2xl border border-slate-600 flex flex-col items-center animate-bounce-in">
                    <h3 class="text-white font-bold mb-4">Choisir une pièce</h3>
                    <div class="flex space-x-4" id="promotion-options">
                        <!-- Les pièces seront injectées ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Joueur (Vous) -->
        <div class="w-full flex justify-between items-start mt-2 px-1">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center border border-green-400/50">
                    <i class="fas fa-user text-green-400"></i>
                </div>
                <div class="flex flex-col leading-tight">
                    <span id="bottom-player-name" class="text-sm font-semibold">Vous</span>
                    <span id="bottom-player-rating" class="text-xs text-gray-400 font-mono"></span>
                </div>
            </div>
             <div id="bottom-indicator" class="hidden px-2 py-0.5 bg-green-500 text-white text-xs font-bold rounded animate-pulse shadow-[0_0_10px_rgba(34,197,94,0.5)]">
                À votre tour
            </div>
        </div>

    </div>

    <!-- FOOTER -->
    <div class="w-full bg-slate-800 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10 p-4 flex-none border-t border-slate-700">
        <div id="themes-container" class="info-transition blur-info">
            <div id="puzzle-themes" class="flex flex-wrap gap-1 mb-4 justify-center max-w-md mx-auto min-h-[1.5rem]"></div>
        </div>

        <div class="grid grid-cols-4 gap-3 max-w-md mx-auto">
            <button id="help-btn" class="col-span-1 bg-purple-600 hover:bg-purple-500 active:bg-purple-700 text-white font-bold py-3 rounded-xl transition shadow flex flex-col items-center justify-center disabled:opacity-40 disabled:saturate-0" title="Aide">
                <i id="help-icon" class="fas fa-question-circle mb-1 text-xl"></i>
                <span id="help-text" class="text-[10px] uppercase tracking-wider">Aide</span>
            </button>
            
            <button id="retry-btn" class="col-span-1 bg-slate-600 hover:bg-slate-500 active:bg-slate-700 text-white font-bold py-3 rounded-xl transition shadow flex flex-col items-center justify-center disabled:opacity-40 disabled:saturate-0" title="Réessayer">
                <i class="fas fa-undo mb-1 text-xl"></i>
                <span class="text-[10px] uppercase tracking-wider">Reset</span>
            </button>
            
            <button id="next-btn" class="col-span-2 bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition shadow flex items-center justify-center space-x-2 disabled:opacity-40 disabled:bg-slate-700 disabled:text-gray-500">
                <span>Suivant</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        // --- AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playSound(type) {
            if (!audioCtx) initAudio(); if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass'; osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'move') {
                osc.type = 'sine'; filter.frequency.setValueAtTime(800, now); osc.frequency.setValueAtTime(300, now); osc.frequency.exponentialRampToValueAtTime(50, now+0.1);
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.3, now+0.01); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                osc.start(now); osc.stop(now+0.1);
            } else if (type === 'error') {
                osc.type = 'triangle'; filter.frequency.setValueAtTime(200, now); osc.frequency.setValueAtTime(70, now); osc.frequency.linearRampToValueAtTime(50, now+0.2);
                gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.2, now+0.05); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3);
                osc.start(now); osc.stop(now+0.35);
            } else if (type === 'win') {
                [261.63, 329.63, 392.00].forEach((f,i)=>{
                    const o=audioCtx.createOscillator();const g=audioCtx.createGain();const fl=audioCtx.createBiquadFilter();
                    o.type='sine';o.frequency.value=f;fl.type='lowpass';fl.frequency.value=1000;
                    o.connect(fl);fl.connect(g);g.connect(audioCtx.destination);
                    const t=now+(i*0.05);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.15,t+0.2);g.gain.exponentialRampToValueAtTime(0.001,t+1.5);
                    o.start(t);o.stop(t+1.6);
                });
            }
        }

        // --- MOCK ---
        const MOCK_PUZZLES = [
            { "game": { "id": "O8sz7nS8", "pgn": "d4 d5 c4 e6 Nc3 Bb4 Nf3 Nf6 e3 Ne4 Qc2 c6 Bd3 f5 O-O O-O Ne5 Nd7 Nxd7 Bxd7 f3 Nxc3 bxc3 Bd6 e4 fxe4 fxe4 dxe4 Bxe4", "players": [ { "name": "euphrates7", "rating": 1988, "color": "white" }, { "name": "ahmadsoltani", "rating": 1927, "color": "black" } ] }, "puzzle": { "id": "f8M0Z", "rating": 1939, "solution": ["d6h2", "g1h2", "f8f1", "e4h7", "g8h8"], "themes": ["deflection", "middlegame", "crushing", "long", "kingsideAttack"], "initialPly": 28 } },
            { "game": { "id": "BMh79XZA", "pgn": "e4 e6 d4 g6 Be3 Bg7 Qd2 Ne7 h4 h5 Nc3 d5 O-O-O dxe4 Nxe4 b6 Nh3 Bb7 Neg5 Nf5 Nf4 Nxe3 fxe3 O-O Bc4 Re8 Qe2 Bh6 g4 Bxg5 hxg5 Bxh1 Rxh1 Qxg5 gxh5 Qh6 Qg2 g5 Nh3 Nd7 Nxg5 Kf8 Rf1 f5 Bxe6 Ke7 Qc6 Rad8 Rxf5 Rf8 Bxd7", "players": [ { "name": "Arxeuz", "rating": 2063, "color": "white" }, { "name": "CarlosAguilar", "rating": 2109, "color": "black" } ] }, "puzzle": { "id": "Ai8r1", "rating": 1583, "solution": ["h6c6", "d7c6", "f8f5"], "themes": ["middlegame", "short", "advantage"], "initialPly": 50 } }
        ];

        // --- VARIABLES ---
        let board = null, game = new Chess(), puzzles = [], currentPuzzleIndex = -1, currentSolution = [], isPuzzleActive = false;
        let selectedSquare = null, hintState = 0, statusTimeout = null, isInfoVisible = false;
        let pendingPromotion = null; // Stocke {source, target} en attente

        // --- DOM ---
        const els = {
            rating: document.getElementById('puzzle-rating'), ratingContainer: document.getElementById('rating-container'),
            themes: document.getElementById('puzzle-themes'), themesContainer: document.getElementById('themes-container'),
            toggleInfoBtn: document.getElementById('toggle-info-btn'), infoIcon: document.getElementById('info-icon'),
            topName: document.getElementById('top-player-name'), topRating: document.getElementById('top-player-rating'), topInd: document.getElementById('top-indicator'),
            bottomName: document.getElementById('bottom-player-name'), bottomRating: document.getElementById('bottom-player-rating'), bottomInd: document.getElementById('bottom-indicator'),
            status: document.getElementById('status-message'), nextBtn: document.getElementById('next-btn'), retryBtn: document.getElementById('retry-btn'),
            helpBtn: document.getElementById('help-btn'), helpIcon: document.getElementById('help-icon'), helpText: document.getElementById('help-text'),
            demoBadge: document.getElementById('demo-badge'),
            promotionModal: document.getElementById('promotion-modal'), promotionOptions: document.getElementById('promotion-options')
        };

        $(document).ready(function() {
            initBoard();
            attachEvents();
            fetchPuzzles();
            $(document).on('click touchstart', function() { initAudio(); });
        });

        function initBoard() {
            const config = {
                draggable: false, // DRAG & DROP DÉSACTIVÉ !
                position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };
            board = Chessboard('myBoard', config);
            $(window).resize(board.resize);
        }

        function attachEvents() {
            $('#next-btn').on('click', nextPuzzle);
            $('#retry-btn').on('click', retryPuzzle);
            $('#help-btn').on('click', handleHelpClick);
            $('#toggle-info-btn').on('click', toggleInfo);

            // GESTIONNAIRE DE CLIC UNIQUE (Ordinateur & Mobile)
            $('#myBoard').on('click', '.square-55d63', function() {
                if (!isPuzzleActive) return;
                const square = $(this).attr('data-square');
                handleSquareClick(square);
            });
        }

        // --- FETCH ---
        async function fetchPuzzles() {
            showStatus("Récupération...", "info");
            els.nextBtn.disabled = true;
            els.demoBadge.classList.add('hidden');
            try {
                const r = await fetch('https://lichess.org/api/puzzle/batch/mix?difficulty=harder&nb=50');
                if (!r.ok) throw new Error("Erreur réseau");
                const d = await r.json();
                let np = Array.isArray(d) ? d : (d.puzzles && Array.isArray(d.puzzles) ? d.puzzles : []);
                if (np.length > 0) { puzzles = np; currentPuzzleIndex = -1; nextPuzzle(); } else throw new Error("Pas de données");
            } catch (e) {
                console.warn(e); showStatus("Mode Démo", "error"); els.demoBadge.classList.remove('hidden');
                puzzles = MOCK_PUZZLES; currentPuzzleIndex = -1; nextPuzzle();
            }
        }

        // --- UI UTILS ---
        function toggleInfo() { isInfoVisible = !isInfoVisible; updateInfoVisibility(); }
        function updateInfoVisibility() {
            if (isInfoVisible) {
                els.ratingContainer.classList.remove('blur-info'); els.themesContainer.classList.remove('blur-info');
                els.infoIcon.className = "fas fa-eye"; els.toggleInfoBtn.classList.add('text-white');
            } else {
                els.ratingContainer.classList.add('blur-info'); els.themesContainer.classList.add('blur-info');
                els.infoIcon.className = "fas fa-eye-slash"; els.toggleInfoBtn.classList.remove('text-white');
            }
        }
        function resetHelpButton() {
            hintState = 0; els.helpText.innerText = "AIDE"; els.helpIcon.className = "fas fa-question-circle mb-1 text-xl";
            $('.square-55d63').removeClass('highlight-hint');
        }

        // --- LOGIQUE INTERACTION (TAP/CLICK ONLY) ---
        function handleSquareClick(square) {
            const piece = game.get(square);
            
            // 1. Déjà une sélection
            if (selectedSquare) {
                // Clic sur la même case -> Désélection
                if (selectedSquare === square) { 
                    deselectSquare(); 
                    return; 
                }
                
                // Clic sur une pièce alliée -> Changement de sélection
                if (piece && piece.color === game.turn()) { 
                    selectSquare(square); 
                    return; 
                }

                // Tentative de mouvement
                checkMove(selectedSquare, square);
                // Note: On ne désélectionne PAS ici, checkMove le fera si le coup est valide ou invalide
            } 
            // 2. Pas de sélection
            else {
                if (piece && piece.color === game.turn()) selectSquare(square);
            }
        }

        function checkMove(source, target) {
            // Vérifier si c'est un coup légal (sans le jouer encore)
            const moves = game.moves({ verbose: true });
            const move = moves.find(m => m.from === source && m.to === target);

            if (!move) {
                // Coup illégal -> On désélectionne et feedback
                deselectSquare();
                // Optionnel: Petit son d'erreur ou rien
                return;
            }

            // Vérifier PROMOTION
            if (move.flags.includes('p')) {
                // Ouvrir la modale
                pendingPromotion = { source, target };
                openPromotionModal(game.turn());
            } else {
                // Coup normal
                attemptMove(source, target);
                deselectSquare();
            }
        }

        // --- GESTION PROMOTION ---
        function openPromotionModal(color) {
            els.promotionOptions.innerHTML = '';
            const pieces = ['q', 'r', 'b', 'n']; // Reine, Tour, Fou, Cavalier
            
            pieces.forEach(p => {
                const img = document.createElement('img');
                img.src = `https://chessboardjs.com/img/chesspieces/wikipedia/${color}${p.toUpperCase()}.png`;
                img.className = "w-12 h-12 bg-slate-600 rounded hover:bg-slate-500 promo-piece";
                img.onclick = () => confirmPromotion(p);
                els.promotionOptions.appendChild(img);
            });

            els.promotionModal.classList.remove('hidden');
        }

        function confirmPromotion(pieceType) {
            if (!pendingPromotion) return;
            els.promotionModal.classList.add('hidden');
            attemptMove(pendingPromotion.source, pendingPromotion.target, pieceType);
            pendingPromotion = null;
            deselectSquare();
        }

        // --- VISUALS ---
        function selectSquare(square) {
            deselectSquare();
            selectedSquare = square;
            $(`#myBoard .square-${square}`).addClass('highlight-selected');
            showLegalMoves(square);
        }

        function deselectSquare() {
            if (selectedSquare) $(`#myBoard .square-${selectedSquare}`).removeClass('highlight-selected');
            selectedSquare = null;
            hideLegalMoves();
        }

        function showLegalMoves(square) {
            hideLegalMoves();
            const moves = game.moves({ square: square, verbose: true });
            moves.forEach(move => {
                const cls = (move.flags.includes('c') || move.flags.includes('e')) ? 'hint-legal-capture' : 'hint-legal-move';
                $(`#myBoard .square-${move.to}`).addClass(cls);
            });
        }
        function hideLegalMoves() { $('.square-55d63').removeClass('hint-legal-move hint-legal-capture'); }
        function highlightLastMove(s, t) {
            setTimeout(() => {
                $('.square-55d63').removeClass('highlight-move');
                $(`#myBoard .square-${s}`).addClass('highlight-move');
                $(`#myBoard .square-${t}`).addClass('highlight-move');
            }, 10);
        }

        // --- GAME LOGIC ---
        function nextPuzzle() {
            currentPuzzleIndex++;
            if (currentPuzzleIndex >= puzzles.length) { fetchPuzzles(); return; }
            loadPuzzle(puzzles[currentPuzzleIndex]);
        }

        function retryPuzzle() {
            if (currentPuzzleIndex >= 0) { loadPuzzle(puzzles[currentPuzzleIndex]); showStatus("Réessayez", "info"); }
        }

        function loadPuzzle(pd) {
            game.reset();
            if (!game.load_pgn(pd.game.pgn)) { showStatus("Erreur PGN", "error"); setTimeout(nextPuzzle, 1000); return; }
            
            let h = game.history({verbose:true}), setup=null;
            game.reset();
            for(let i=0; i<pd.puzzle.initialPly; i++) game.move(h[i]);
            if(h[pd.puzzle.initialPly]) { setup=h[pd.puzzle.initialPly]; game.move(setup); }

            board.position(game.fen(), false);
            board.orientation(game.turn()==='w'?'white':'black');

            currentSolution = [...pd.puzzle.solution];
            isPuzzleActive = true;
            deselectSquare(); resetHelpButton(); isInfoVisible=false; updateInfoVisibility();

            if(setup) { highlightLastMove(setup.from, setup.to); playSound('move'); }

            els.rating.innerText = pd.puzzle.rating;
            renderThemes(pd.puzzle.themes);
            
            const wp = pd.game.players.find(p=>p.color==='white')||{}, bp = pd.game.players.find(p=>p.color==='black')||{};
            if(board.orientation()==='white') updateInfos(wp, bp); else updateInfos(bp, wp);
            
            updateTurn();
            els.nextBtn.disabled=true; els.retryBtn.disabled=false; els.helpBtn.disabled=false;
            hideStatus();
        }

        function updateInfos(b, t) {
            els.bottomName.innerText = b.name||'?'; els.bottomRating.innerText = `(${b.rating||'?'})`;
            els.topName.innerText = t.name||'?'; els.topRating.innerText = `(${t.rating||'?'})`;
        }
        function renderThemes(t) {
            els.themes.innerHTML=''; if(!t)return;
            t.forEach(th=>{
                const s=document.createElement('span'); s.innerText=th.charAt(0).toUpperCase()+th.slice(1);
                s.className="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded border border-slate-600";
                els.themes.appendChild(s);
            });
        }
        function updateTurn() {
            if(isPuzzleActive) { els.bottomInd.classList.remove('hidden'); els.topInd.classList.add('hidden'); }
            else els.bottomInd.classList.add('hidden');
        }

        // --- MOVE EXECUTION ---
        function attemptMove(source, target, promotionPiece = 'q') {
            if (!isPuzzleActive) return false;

            let move = game.move({ from: source, to: target, promotion: promotionPiece });
            if (move === null) {
                // Coup invalide
                playSound('error'); showStatus("Coup invalide", "error"); return false;
            }

            let uci = source + target;
            if (move.promotion) uci += move.promotion;

            if (uci === currentSolution[0]) {
                // BON COUP
                currentSolution.shift();
                board.position(game.fen());
                highlightLastMove(source, target);
                clearHints(); playSound('move');

                if (currentSolution.length === 0) {
                    playSound('win'); winPuzzle();
                } else {
                    els.bottomInd.classList.add('hidden'); els.topInd.classList.remove('hidden');
                    setTimeout(playOpponent, 600);
                }
                return true;
            } else {
                // MAUVAIS COUP
                game.undo(); board.position(game.fen());
                playSound('error'); showStatus("Mauvais coup", "error");
                return false;
            }
        }

        function playOpponent() {
            if (currentSolution.length === 0) return;
            const uci = currentSolution[0];
            const s = uci.substring(0,2), t = uci.substring(2,4), p = uci.length>4?uci.substring(4,5):undefined;
            game.move({from:s, to:t, promotion:p});
            board.position(game.fen());
            highlightLastMove(s,t); playSound('move');
            currentSolution.shift(); updateTurn();
        }

        function winPuzzle() {
            isPuzzleActive = false; showStatus("Gagné !", "success");
            isInfoVisible = true; updateInfoVisibility();
            els.nextBtn.disabled=false; els.retryBtn.disabled=true; els.helpBtn.disabled=true;
            els.bottomInd.classList.add('hidden'); els.topInd.classList.add('hidden');
        }

        // --- HELPERS ---
        function handleHelpClick() {
            if(!isPuzzleActive || currentSolution.length===0) return;
            const m = currentSolution[0], s = m.substring(0,2), t = m.substring(2,4);
            if(hintState===0) {
                $('.square-55d63').removeClass('highlight-hint'); $(`#myBoard .square-${s}`).addClass('highlight-hint');
                showStatus("Pièce indiquée", "info"); hintState=1; els.helpText.innerText="SOLUCE"; els.helpIcon.className="fas fa-lightbulb mb-1 text-xl";
            } else attemptMove(s, t);
        }
        function clearHints() { $('.square-55d63').removeClass('highlight-hint'); resetHelpButton(); }
        function showStatus(t, type) {
            if(statusTimeout) clearTimeout(statusTimeout); els.status.innerText=t;
            els.status.className="absolute top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-2 rounded-full font-bold shadow-2xl transition-all duration-300 opacity-100 translate-y-0 whitespace-nowrap border border-white/10 bg-slate-800/95 backdrop-blur text-sm";
            if(type==='error') els.status.classList.add('text-red-400','border-red-500/30');
            else if(type==='success') els.status.classList.add('text-green-400','border-green-500/30');
            else els.status.classList.add('text-blue-200');
            statusTimeout=setTimeout(()=>els.status.classList.replace('opacity-100','opacity-0'), 2000);
        }
        function hideStatus() { els.status.classList.replace('opacity-100','opacity-0'); }
    </script>
</body>
</html>